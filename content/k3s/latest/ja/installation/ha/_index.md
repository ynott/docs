---
title: "外部DBによる高可用性"
weight: 30
---

>**注意:** 高可用性(HA)の公式サポートは、v1.0.0リリースで導入されました。

単一サーバクラスタはさまざまなユースケースに対応できますが、Kubernetesコントロールプレーンの稼働時間が重要な環境では、HA構成でK3sを実行できます。HAのK3sクラスタは、次のコンポーネントで構成されています:

* Kubernetes APIと他のコントロールプレーンサービスを実行する2つ以上の **サーバノード**
* **外部データストア** (シングルサーバのセットアップで使用される組み込みSQLiteデータストアとは対照的なもの)
* ワーカーノードがクラスタに登録できるようにサーバーノードのフロントには**固定の登録アドレス**があること

次の図は、上記の設定を示しています:
![k3s HA]({{< baseurl >}}/img/k3s/k3s-production-setup.svg)

このアーキテクチャでは、サーバノードは`k3s server`コマンドを実行するマシン(ベアメタルまたは仮想)として定義しています。ワーカーノードは、`k3s agent`コマンドを実行するマシンとして定義しています。

ワーカーは固定の登録アドレスを使用して登録しますが、登録後はサーバー・ノードの1つに直接接続します。これは、 `k3s agent` プロセスによって開始されるWebソケット接続であり、エージェントプロセスの一部として実行されるクライアント側のロードバランサによって維持されます。

インストールの概要
--------------------
HAクラスタをセットアップするには、次の手順を実行する必要があります:

1. 外部データストアを作成する
2. サーバ・ノードの起動
3. 固定の登録アドレスを設定する
4. ワーカーノードを接続

### 外部データストアの作成
最初に、クラスタの外部データストアを作成する必要があります。詳細については、[クラスタデータストアオプション]({{< baseurl >}}/k3s/latest/en/installation/datastore/)を参照してください。

### サーバー・ノードの起動
このHA構成では、K3sには2つ以上のサーバノードを必要とします。最小マシン要件については、[ノード要件]({{< baseurl >}}/k3s/latest/ja/installation/node-requirements/)ガイドを参照してください。

これらのノードで `k3s server` コマンドを実行する場合は、K3が外部データストアへの接続方法を認識できるように `datastore-endpoint` パラメータを設定する必要があります。このパラメータの構成については、[データストア構成ガイド]({{< baseurl >}}/k3s/latest/en/installation/datastore/#external-datastore-configuration-parameters)を参照してください。

> **注意:** HAインストールでは、単一サーバーのインストールと同じインストールオプションを使用できます。詳細については、[インストールおよび構成オプション]({{< baseurl >}}/k3s/latest/en/installation/install-options/)のマニュアルを参照してください。

デフォルトでは、サーバ・ノードにスケジューリングできる設定のため、その上でワークロードを起動できます。ユーザワークロードを実行しない専用のコントロールプレーンが必要な場合は、taintを使用できます。<span style='white-space:nowrap'>`node-taint`</span>パラメータを使用するとノードをtaintに設定できます。例えば、 <span style='white-space: nowrap'>`--node-taint k3s-controlplane=true:NoExecute`</span>のように設定します。

すべてのサーバーノードで `k3s server` プロセスを起動したら、 `k3s kubectl get nodes` を使用してノードが準備完了状態であることを確認することで、クラスタが正しく起動したことを確認できます。

### 固定登録アドレスを構成する
ワーカーノードを動かすには、登録にURLが必要です。任意のサーバ・ノードのIPまたはホスト名を指定できますが、多くの場合、これらは時間の経過とともに変更されます。たとえば、グループの拡張をサポートするクラウドでクラスタを実行している場合、サーバーノードグループを時間の経過とともに拡大または縮小すると、ノードが作成されて破棄されるため、サーバーノードの初期セットとは異なるIPを持つことになります。したがって、サーバー・ノードの前には、時間が経っても変化しない安定したエンドポイントが必要です。このエンドポイントは、次のようないくつかのアプローチを使用して設定できます。

* L4 (TCP) ロードバランサー
* ラウンドロビンDNS
* 仮想IPアドレスまたは柔軟なIPアドレス

このエンドポイントは、Kubernetes APIへのアクセスにも使用できます。したがって、たとえば、kubeconfigファイルを特定のノードではなくそれを指すように変更できます。

### ワーカーノードを追加
HAクラスタへのワーカーノードの追加は、単一サーバークラスタ内のワーカーノードの追加と同じです。エージェントが登録するURLと使用するトークンを指定するだけです。
```
K3S_TOKEN=SECRET k3s agent --server https://fixed-registration-address:6443
```
