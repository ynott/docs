---
title: "外部DBによるHA構成"
weight: 30
---

>**注意:** HA構成は、リリースv1.0.0で公式にサポートされました。

この章では、外部データベースを利用したHA構成のK3sクラスターのインストール方法について解説します。

シングルサーバークラスターはさまざまなユースケースに対応できますが、Kubernetesコントロールプレーンの稼働率が重要な環境では、HA構成でK3sを実行できます。HAのK3sクラスターは、次のコンポーネントで構成されています:

* Kubernetes APIサービスとその他のコントロールプレーンサービスが動く2つ以上の**サーバーノード**
* **外部のデータストア(データベース)** (シングルサーバーで使用される組み込みSQLiteデータベースではない)
* ワーカーノードがクラスタに登録できるようにサーバーノードのフロントには**登録の固定IPアドレス**があること

これらのコンポーネントがどのように連携しているかは、[アーキテクチャ]({{<baseurl>}}/k3s/latest/en/architecture/#high-availability-with-an-external-db)の章を参照してください。

ワーカーは登録の固定IPアドレスを使用して登録されますが、登録後はサーバー・ノードの1つに直接接続します。これは、 `k3s agent` プロセスによって開始されるWebソケット接続であり、エージェントプロセスの一部として実行されるクライアント側のロードバランサによって維持されます。

# インストールの概要

HAクラスターをセットアップするには、次の手順で実行します:

1. [外部データストアの作成](#1._外部データストアの作成)
2. [サーバーノードの起動](#2._サーバーノードの起動)
3. [登録の固定IPアドレスを設定](#3._固定登録アドレスを構成する)
4. [ワーカーノードを追加](#4._ワーカーノードを追加)

### 1. 外部データストアの作成
最初に、クラスタの外部データストアを作成する必要があります。詳細については、[クラスタデータストアオプション]({{< baseurl >}}/k3s/latest/en/installation/datastore/)を参照してください。

### 2. サーバー・ノードの起動
HA構成のK3sでは、2つ以上のサーバーノードが必要です。ノードの最小要件については、[ノード要件]({{< baseurl >}}/k3s/latest/ja/installation/node-requirements/)の章を参照してください。

`k3s server`コマンドを実行するノードは、K3sが外部データストアへの接続方法を識別できるように`datastore-endpoint`パラメータを設定する必要があります。このパラメータの構成については、[データストア構成ガイド]({{< baseurl >}}/k3s/latest/en/installation/datastore/#external-datastore-configuration-parameters)を参照してください。

> **注意:** HA構成のインストールでも、シングルサーバーのインストールと同じインストールオプションを利用します。インストールオプションの詳細については、[インストールおよび構成オプション]({{< baseurl >}}/k3s/latest/en/installation/install-options/)を参照してください。

デフォルトでは、サーバーノードにユーザーのワークロードをスケジューリングできる設定のため、その上でワークロードを動かせます。ユーザーのワークロードを実行しない専用のコントロールプレーンにしたい場合は、taintを指定してください<span style='white-space:nowrap'>`node-taint`</span>パラメータを使用するとノードをtaintに設定できます。例えば、 <span style='white-space: nowrap'>`--node-taint k3s-controlplane=true:NoExecute`</span>のように設定します。

すべてのサーバーノードで`k3s server`プロセスを起動したら、`k3s kubectl get nodes`を使用して、ノードを確認します。全てのノードがレディ(ready)になっていればクラスタが正しく起動しています。

### 3. 登録固定IPアドレスを構成する
ワーカーノードを動かす時に登録用にURLが必要です。サーバーノードのIPまたは任意のホスト名を指定できますが、これらは時間の経過とともに変わることがよくあります。たとえば、スケールアウトをできるクラウド上でクラスターを実行している場合、時間の経過とともにサーバーのノードグループが拡大または縮小されると、ノードが作成されたり破棄されるため、サーバーノードの初期セットアップ時とは異なるIPアドレスを持つことになります。したがって、サーバーノードのフロントには、時間が経っても変化しない安定したエンドポイントが必要です。このようなエンドポイントを構成する方法には、次のような方法があります。

* L4 (TCP) ロードバランサー
* ラウンドロビンDNS
* 仮想IPアドレスまたはElastic IPアドレス

このエンドポイントは、Kubernetes APIへのアクセスにも使用できます。例えば、これにより[kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/)ファイルの接続先を特定のノードではなくエンドポイントを指すように変更できます。

### 4. ワーカーノードを追加
HA構成クラスターにワーカーノードをシングルサーバークラスターのワーカーノードと同じように追加します。登録するURLとクラスターのトークンをエージェントに指定します。
```
K3S_TOKEN=SECRET k3s agent --server https://fixed-registration-address:6443
```
