---
title: "外部DBによる高可用性構成"
weight: 30
---

>**注意:** 高可用性(HA)の公式サポートは、v1.0.0リリースで導入されました。

この章では、外部データベースを利用した高可用性(HA構成)のK3sクラスターのインストール方法について解説します。

シングルサーバクラスタはさまざまなユースケースに対応できますが、Kubernetesコントロールプレーンの稼働率が重要な環境では、HA構成でK3sを実行できます。HAのK3sクラスタは、次のコンポーネントで構成されています:

* 2つ以上の**サーバノード**でKubernetes APIと他のコントロールプレーンサービスを実行
* **外部データストア** (シングルサーバのセットアップで使用される組み込みSQLiteデータストアとは対照的なもの)
* ワーカーノードがクラスタに登録できるようにサーバーノードのフロントには**固定の登録アドレス**があること

これらのコンポーネントがどのように連携しているかは、[architecture section.]({{<baseurl>}}/k3s/latest/en/architecture/#high-availability-with-an-external-db)を参照してください。

ワーカーは固定の登録アドレスを使用して登録しますが、登録後はサーバー・ノードの1つに直接接続します。これは、 `k3s agent` プロセスによって開始されるWebソケット接続であり、エージェントプロセスの一部として実行されるクライアント側のロードバランサによって維持されます。

# インストールの概要

HAクラスタをセットアップするには、次の手順を実行する必要があります:

1. [外部データストアを作成する](#1. 外部データストアの作成)
2. [サーバ・ノードの起動](2. サーバー・ノードの起動)
3. [固定の登録アドレスを設定する](3. 固定登録アドレスを構成する)
4. [ワーカーノードを接続](4. ワーカーノードを追加)

### 1. 外部データストアの作成
最初に、クラスタの外部データストアを作成する必要があります。詳細については、[クラスタデータストアオプション]({{< baseurl >}}/k3s/latest/en/installation/datastore/)を参照してください。

### 2. サーバー・ノードの起動
このHA構成では、K3sには2つ以上のサーバノードが必要です。ノードの最小要件については、[ノード要件]({{< baseurl >}}/k3s/latest/ja/installation/node-requirements/)ガイドを参照してください。

これらのノードで`k3s server`コマンドを実行する場合は、K3が外部データストアへの接続方法を認識できるように `datastore-endpoint` パラメータを設定する必要があります。このパラメータの構成については、[データストア構成ガイド]({{< baseurl >}}/k3s/latest/en/installation/datastore/#external-datastore-configuration-parameters)を参照してください。

> **注意:** HA構成のインストールでも、シングルサーバーのインストールと同じインストールオプションが使えます。インストールオプションの詳細については、[インストールおよび構成オプション]({{< baseurl >}}/k3s/latest/en/installation/install-options/)を参照してください。

デフォルトでは、サーバーノードにスケジューリングできる設定のため、その上でワークロードを動かせます。ユーザワークロードを実行しない専用のコントロールプレーンが必要な場合は、taintを指定してください<span style='white-space:nowrap'>`node-taint`</span>パラメータを使用するとノードをtaintに設定できます。例えば、 <span style='white-space: nowrap'>`--node-taint k3s-controlplane=true:NoExecute`</span>のように設定します。

すべてのサーバーノードで`k3s server`プロセスを起動したら、`k3s kubectl get nodes`を使用してノードがレディになっていればクラスタが正しく起動しています。

### 3. 固定登録アドレスを構成する
ワーカーノードを動かすには、登録にURLが必要です。サーバーノードのIPまたは任意のホスト名を指定できますが、これらは時間の経過とともに変更されることがよくあります。たとえば、スケールアウトをサポートしたクラウド上でクラスタを実行している場合、時間の経過とともにサーバーノードグループが拡大または縮小されると、ノードが作成されたり破棄されるため、サーバーノードの初期セットアップ時とは異なるIPを持つことになります。したがって、サーバーノードのフロントには、時間が経っても変化しない安定したエンドポイントが必要です。このエンドポイントの設置には、次のような構成方法があります。

* L4 (TCP) ロードバランサー
* ラウンドロビンDNS
* 仮想IPアドレスまたは柔軟なIPアドレス

このエンドポイントは、Kubernetes APIへのアクセスにも使用できます。例えば、これにより[kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/)ファイルの接続先を特定のノードではなくエンドポイントを指すように変更できます。

### 4. ワーカーノードを追加
HAクラスタへのワーカーノードは、シングルサーバークラスタ内のワーカーノードと同じように追加します。登録するURLとクラスターのトークンをエージェントに指定します。
```
K3S_TOKEN=SECRET k3s agent --server https://fixed-registration-address:6443
```
