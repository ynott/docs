---
title: "アーキテクチャ"
weight: 1
---

このページでは、高可用性構成のK3sサーバークラスターのアーキテクチャとシングルノードのサーバークラスターとの違いについて説明します。

また、エージェントノードがK3sサーバーにどのように登録されるかについても説明します。

サーバーノードは`k3s server`コマンドを実行するマシン(ベアメタルや仮想マシン)と定義します。ワーカーノードは、`k3s agent`コマンドを動かすマシンと定義します。

このページでは、以下のトピックについて取り上げます:

- [組み込みDBでのシングルサーバーのセットアップ](#組み込みDBでのシングルサーバーのセットアップ)
- [外部データベースを使ったHA構成のK3sサーバー](#外部データベースを使ったHA構成のK3sサーバー)
  - [エージェントノード用の登録固定IPアドレス](#エージェントノード用の登録固定IPアドレス)
- [エージェントノードが登録されるときの動作](#エージェントノードが登録されるときの動作)

# 組み込みDBでのシングルサーバーのセットアップ

以下のダイアグラムは、組み込みSQLiteデータベースを使ったシングルノードのK3sサーバーのクラスターの例です。

この構成では、各エージェントノードが同じサーバーに登録されます。K3sユーザーは、サーバーノード上でK3s APIを呼び出すことによりKubernetesリソースを操作できます。

![アーキテクチャ図]({{<baseurl>}}/img/rancher/k3s-single-node-server-architecture.svg)

# 外部データベースを使ったHA構成のK3sサーバー

シングルサーバーのクラスターで様々なユースケースに対応できますが、Kubernetesのコントロールプレーンの稼働時間が重要な環境である場合、HA構成でK3sを実行できます。HA構成のK3sクラスターは次のもので構成されます:

* Kubernetes APIサービスとその他のコントロールプレーンサービスが動く2つ以上の**サーバーノード**
* **外部のデータストア(データベース)** (シングルサーバーで使用される組み込みSQLiteデータベースではない)

![アーキテクチャ図]({{< baseurl >}}/img/rancher/k3s-ha-architecture.svg)

### エージェントノード用の登録固定IPアドレス

HA構成では下の図に示すとおり、各ノードがKubernetes APIに登録するときに固定IPアドレスが必要です。

登録後、エージェントノードは固定IPアドレス経由ではなくサーバーノードの一つに直接接続します。

![k3s HA構成図]({{< baseurl >}}/img/k3s/k3s-production-setup.svg)

# エージェントノードが登録されるときの動作

エージェントノードは、`k3s agent`プロセスが開始したWebsocket接続によって登録され、エージェントプロセスの一部として実行されているクライアント側のロードバランサーにより接続が維持されます。

エージェントは、ノード用のランダムに生成されたパスワードを`/etc/rancher/node/password`に保存し、それをノードクラスターのシークレットとして使用してサーバーに登録します。サーバーにはノード毎の個別のパスワードが`/var/lib/rancher/k3s/server/cred/node-passwd`に保存されています。それ以降の接続では、同じパスワードを使用する必要があります。

エージェントの`/etc/rancher/node`ディレクトリが削除された場合、エージェントのパスワードファイルを再作成するか、サーバーからエントリを削除する必要があります。

`--with-node-id`フラグを使用してK3sサーバーまたはエージェントを起動することにより、ノード毎の一意のノードIDをホスト名に追加できます。
